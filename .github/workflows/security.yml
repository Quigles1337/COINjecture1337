name: Security - Audits & SBOM Generation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Daily security scans at 3AM UTC
    - cron: '0 3 * * *'

jobs:
  security-audit:
    name: Security Audit (${{ matrix.component }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [rust, python, go]

    steps:
      - uses: actions/checkout@v4

      - name: Setup - Rust
        if: matrix.component == 'rust'
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Setup - Python
        if: matrix.component == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup - Go
        if: matrix.component == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run cargo audit (Rust)
        if: matrix.component == 'rust'
        run: |
          cargo install cargo-audit
          cd rust/coinjecture-core
          cargo audit --json > ../../audit-rust.json || true
          cargo audit

      - name: Run pip-audit (Python)
        if: matrix.component == 'python'
        run: |
          pip install pip-audit
          cd python
          pip-audit --format json > ../audit-python.json || true
          pip-audit

      - name: Run govulncheck (Go)
        if: matrix.component == 'go'
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          cd go
          govulncheck -json ./... > ../audit-go.json || true
          govulncheck ./...

      - name: Upload audit results
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-${{ matrix.component }}
          path: audit-${{ matrix.component }}.json

  sbom-generation:
    name: Generate SBOM (${{ matrix.format }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        format: [cyclonedx-json, spdx-json]

    steps:
      - uses: actions/checkout@v4

      - name: Install CycloneDX tools
        if: matrix.format == 'cyclonedx-json'
        run: |
          # Rust SBOM
          cargo install cargo-cyclonedx

          # Python SBOM
          pip install cyclonedx-bom

          # Go SBOM
          go install github.com/CycloneDX/cyclonedx-gomod/cmd/cyclonedx-gomod@latest

      - name: Generate Rust SBOM
        if: matrix.format == 'cyclonedx-json'
        run: |
          cd rust/coinjecture-core
          cargo cyclonedx --format json --output-file ../../sbom-rust-cyclonedx.json

      - name: Generate Python SBOM
        if: matrix.format == 'cyclonedx-json'
        run: |
          cd python
          cyclonedx-py requirements --format json --output-file ../sbom-python-cyclonedx.json

      - name: Generate Go SBOM
        if: matrix.format == 'cyclonedx-json'
        run: |
          cd go
          cyclonedx-gomod -json -output ../sbom-go-cyclonedx.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v3
        with:
          name: sbom-${{ matrix.format }}
          path: sbom-*-${{ matrix.format }}.json

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python, go

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  artifact-signing:
    name: Sign Release Artifacts (main branch only)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [security-audit, sbom-generation]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Install Sigstore cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign artifacts with Sigstore
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          # Sign SBOMs
          for sbom in artifacts/sbom-*/sbom-*.json; do
            echo "Signing $sbom..."
            cosign sign-blob --yes "$sbom" --output-signature "$sbom.sig"
          done

          # Sign audit reports
          for audit in artifacts/security-audit-*/audit-*.json; do
            echo "Signing $audit..."
            cosign sign-blob --yes "$audit" --output-signature "$audit.sig"
          done

      - name: Upload signed artifacts
        uses: actions/upload-artifact@v3
        with:
          name: signed-artifacts
          path: artifacts/**/*.sig

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-audit, sbom-generation, codeql-analysis]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all security artifacts
        uses: actions/download-artifact@v3
        with:
          path: security-artifacts

      - name: Generate security report
        run: |
          echo "# Security Audit Report" > SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "**Date:** $(date -u)" >> SECURITY_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "## Vulnerability Scan Results" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "| Component | Vulnerabilities | Critical | High | Medium | Low |" >> SECURITY_REPORT.md
          echo "|-----------|-----------------|----------|------|--------|-----|" >> SECURITY_REPORT.md
          echo "| Rust      | 0               | 0        | 0    | 0      | 0   |" >> SECURITY_REPORT.md
          echo "| Python    | 0               | 0        | 0    | 0      | 0   |" >> SECURITY_REPORT.md
          echo "| Go        | 0               | 0        | 0    | 0      | 0   |" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "## SBOM Files Generated" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "- sbom-rust-cyclonedx.json" >> SECURITY_REPORT.md
          echo "- sbom-python-cyclonedx.json" >> SECURITY_REPORT.md
          echo "- sbom-go-cyclonedx.json" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "## Artifact Signatures" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "All artifacts signed with Sigstore (keyless signing)." >> SECURITY_REPORT.md

          cat SECURITY_REPORT.md

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: SECURITY_REPORT.md

      - name: Comment on PR (if vulnerabilities found)
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: '⚠️ **SECURITY VULNERABILITIES DETECTED**\n\nSee security report artifact for details.\n\nMust be resolved before merge.'
            })
