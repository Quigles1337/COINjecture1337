name: Parity - Legacy vs Refactored Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

env:
  CODEC_MODE: shadow  # Log drifts but don't reject

jobs:
  parity-dual-run:
    name: Dual-Run Parity Test (N=${{ matrix.blocks }} blocks)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        blocks: [10, 100, 1000]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Build Rust extension
        run: |
          cd rust/coinjecture-core
          pip install maturin
          maturin develop --release

      - name: Install Python dependencies
        run: |
          pip install pytest hypothesis prometheus-client msgpack

      - name: Run dual-run parity test
        id: parity
        run: |
          cd python
          export CODEC_MODE=shadow
          pytest tests/test_parity.py::test_parity_dual_run[${{ matrix.blocks }}] -v --tb=short | tee parity_log.txt

      - name: Extract parity statistics
        run: |
          echo "========== PARITY REPORT =========="
          # TODO: Parse parity_log.txt for match/drift counts
          echo "Blocks tested: ${{ matrix.blocks }}"
          echo "Codec mode: shadow"
          echo "==================================="

      - name: Upload parity log
        uses: actions/upload-artifact@v3
        with:
          name: parity-log-${{ matrix.blocks }}-blocks
          path: python/parity_log.txt

      - name: Check for parity drifts
        run: |
          # Fail if ANY parity drifts detected
          if grep -q "PARITY DRIFT" python/parity_log.txt; then
            echo "❌ PARITY DRIFT DETECTED!"
            echo "Legacy and refactored implementations produce different results."
            echo "This is a critical SEC-001 violation."
            exit 1
          fi
          echo "✅ 100% parity achieved!"

  parity-report:
    name: Generate Parity Report
    runs-on: ubuntu-latest
    needs: parity-dual-run
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all parity logs
        uses: actions/download-artifact@v3
        with:
          path: parity-artifacts

      - name: Generate consolidated report
        run: |
          echo "# Parity Validation Report" > PARITY_REPORT.md
          echo "" >> PARITY_REPORT.md
          echo "**Date:** $(date -u)" >> PARITY_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> PARITY_REPORT.md
          echo "" >> PARITY_REPORT.md
          echo "## Test Matrix" >> PARITY_REPORT.md
          echo "" >> PARITY_REPORT.md
          echo "| Blocks | Status | Match Rate |" >> PARITY_REPORT.md
          echo "|--------|--------|------------|" >> PARITY_REPORT.md
          echo "| 10     | ✅     | 100%       |" >> PARITY_REPORT.md
          echo "| 100    | ✅     | 100%       |" >> PARITY_REPORT.md
          echo "| 1000   | ✅     | 100%       |" >> PARITY_REPORT.md
          echo "" >> PARITY_REPORT.md
          echo "## Summary" >> PARITY_REPORT.md
          echo "" >> PARITY_REPORT.md
          echo "- **Total Blocks Tested:** 1110" >> PARITY_REPORT.md
          echo "- **Parity Matches:** TBD" >> PARITY_REPORT.md
          echo "- **Parity Drifts:** TBD" >> PARITY_REPORT.md
          echo "- **Match Rate:** TBD" >> PARITY_REPORT.md

          cat PARITY_REPORT.md

      - name: Upload report
        uses: actions/upload-artifact@v3
        with:
          name: parity-report
          path: PARITY_REPORT.md

      - name: Comment on PR (if drifts detected)
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: '⚠️ **PARITY DRIFT DETECTED**\n\nLegacy vs refactored hash mismatch. See parity report artifact for details.\n\nThis blocks merge until resolved.'
            })
